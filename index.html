<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenRouter Key Stats Visualizer</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js for graphing -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        /* Custom styles */
        body {
            font-family: 'Inter', sans-serif;
        }
        .card {
            background-color: #1f2937; /* gray-800 */
            border: 1px solid #374151; /* gray-700 */
            border-radius: 0.75rem; /* rounded-xl */
            padding: 1.5rem; /* p-6 */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        /* Simple spinner animation */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-left-color: #fff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-2xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-white">OpenRouter Key Stats</h1>
            <p class="text-gray-400 mt-2">Enter your OpenRouter API key to see your usage details.</p>
        </header>

        <main>
            <!-- Saved Keys Section -->
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg mb-4">
                <label for="savedKeys" class="block text-sm font-medium text-gray-300 mb-2">Saved Keys</label>
                <div class="flex items-center gap-4">
                    <select id="savedKeys" class="flex-grow w-full bg-gray-700 text-white border border-gray-600 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                        <option value="">Select a saved key</option>
                    </select>
                    <button id="deleteKeyButton" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 flex items-center justify-center" title="Delete Selected Key">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Input section -->
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg mb-8">
                <div class="flex flex-col sm:flex-row items-center gap-4">
                    <input type="password" id="apiKeyInput" placeholder="Enter your OpenRouter API key (or_...)" class="flex-grow w-full bg-gray-700 text-white placeholder-gray-400 border border-gray-600 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                    <button id="fetchButton" class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition duration-200 flex items-center justify-center">
                        <span id="buttonText">Fetch Stats</span>
                        <div id="spinner" class="spinner hidden ml-2"></div>
                    </button>
                </div>
                 <p class="text-xs text-gray-500 mt-3 text-center sm:text-left">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 1.944A11.954 11.954 0 012.166 5.026a12.017 12.017 0 01-1.166 5.81c-.244 1.348.114 2.76.815 3.995a11.988 11.988 0 01.815 1.487c.296.56.653 1.086 1.058 1.579a11.973 11.973 0 011.579 1.058c.493.405 1.018.762 1.579.058a11.987 11.987 0 011.487.815c1.235.701 2.647 1.058 3.995.815a12.017 12.017 0 015.81-1.166A11.954 11.954 0 0110 1.944zM8.707 8.707a1 1 0 00-1.414 1.414L8.586 11.414l-1.293 1.293a1 1 0 001.414 1.414L10 12.828l1.293 1.293a1 1 0 001.414-1.414L11.414 11.414l1.293-1.293a1 1 0 00-1.414-1.414L10 10.086 8.707 8.707z" clip-rule="evenodd" /></svg>
                    Your key is not stored and is only used to make a direct request to the OpenRouter API.
                </p>
            </div>

            <!-- Results container -->
            <div id="resultsContainer" class="hidden">
                <!-- Key Label Card -->
                <div class="card mb-6">
                     <h2 class="text-lg font-semibold text-gray-300 mb-2">Key Label</h2>
                     <p id="keyLabel" class="text-2xl font-bold text-white">-</p>
                </div>

                <!-- Usage and Limit Card -->
                <div class="card mb-6">
                    <h2 class="text-lg font-semibold text-gray-300 mb-4">Usage & Limit</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center">
                        <div>
                            <p class="text-sm text-gray-400">Usage</p>
                            <p id="usage" class="text-3xl font-bold text-red-400">-</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-400">Limit</p>
                            <p id="limit" class="text-3xl font-bold text-green-400">-</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-400">Remaining</p>
                            <p id="limitRemaining" class="text-3xl font-bold text-blue-400">-</p>
                        </div>
                    </div>
                    <!-- Progress Bar -->
                    <div class="mt-6">
                        <div class="w-full bg-gray-700 rounded-full h-4">
                            <div id="progressBar" class="bg-gradient-to-r from-blue-500 to-cyan-400 h-4 rounded-full transition-all duration-500 ease-out" style="width: 0%;"></div>
                        </div>
                        <p id="progressLabel" class="text-right text-sm mt-2 text-gray-400">0% Used</p>
                    </div>
                </div>

                <!-- Credits Card -->
                <div class="card mb-6">
                    <h2 class="text-lg font-semibold text-gray-300 mb-4">Credits</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center">
                        <div>
                            <p class="text-sm text-gray-400">Total Credits</p>
                            <p id="totalCredits" class="text-3xl font-bold text-green-400">-</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-400">Usage</p>
                            <p id="creditsUsage" class="text-3xl font-bold text-red-400">-</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-400">Remaining</p>
                            <p id="creditsRemaining" class="text-3xl font-bold text-blue-400">-</p>
                        </div>
                    </div>
                    <!-- Progress Bar -->
                    <div class="mt-6">
                        <div class="w-full bg-gray-700 rounded-full h-4">
                            <div id="creditsProgressBar" class="bg-gradient-to-r from-green-500 to-teal-400 h-4 rounded-full transition-all duration-500 ease-out" style="width: 0%;"></div>
                        </div>
                        <p id="creditsProgressLabel" class="text-right text-sm mt-2 text-gray-400">0% Used</p>
                    </div>
                </div>

                <!-- History Chart Card -->
                <div class="card">
                    <h2 class="text-lg font-semibold text-gray-300 mb-4">Usage History (Remaining Credits)</h2>
                    <div class="relative h-64 md:h-80">
                        <canvas id="usageHistoryChart"></canvas>
                    </div>
                </div>

                <!-- Other Info Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                    <div class="card">
                         <h3 class="text-lg font-semibold text-gray-300 mb-3">Rate Limit</h3>
                         <div class="flex items-center space-x-4">
                            <div class="bg-gray-700 p-3 rounded-full">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-cyan-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
                            </div>
                            <div>
                                <p id="rateLimit" class="text-xl font-semibold text-white">-</p>
                                <p class="text-sm text-gray-400">Requests per interval</p>
                            </div>
                         </div>
                    </div>
                    <div class="card">
                        <h3 class="text-lg font-semibold text-gray-300 mb-3">Status</h3>
                        <div class="flex items-center space-x-4">
                             <div class="bg-gray-700 p-3 rounded-full">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-yellow-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                            </div>
                            <div>
                                <p id="freeTierStatus" class="text-xl font-semibold text-white">-</p>
                                <p class="text-sm text-gray-400">Free Tier</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Error message container -->
            <div id="errorContainer" class="hidden card bg-red-900 border-red-700 text-red-200 mt-6">
                <p id="errorMessage"></p>
            </div>

        </main>
    </div>

    <script>
        // --- DOM Element References ---
        const apiKeyInput = document.getElementById('apiKeyInput');
        const fetchButton = document.getElementById('fetchButton');
        const buttonText = document.getElementById('buttonText');
        const spinner = document.getElementById('spinner');
        const resultsContainer = document.getElementById('resultsContainer');
        const errorContainer = document.getElementById('errorContainer');
        const errorMessage = document.getElementById('errorMessage');
        const savedKeysSelect = document.getElementById('savedKeys');
        const deleteKeyButton = document.getElementById('deleteKeyButton');
        
        // --- LocalStorage Keys ---
        const STORAGE_KEYS = 'openRouterKeys';
        const STORAGE_HISTORY = 'openRouterKeyHistory';

        // --- Result Display Elements ---
        const keyLabel = document.getElementById('keyLabel');
        const usage = document.getElementById('usage');
        const limit = document.getElementById('limit');
        const limitRemaining = document.getElementById('limitRemaining');
        const progressBar = document.getElementById('progressBar');
        const progressLabel = document.getElementById('progressLabel');
        const rateLimit = document.getElementById('rateLimit');
        const freeTierStatus = document.getElementById('freeTierStatus');

        // --- Credits Display Elements ---
        const totalCredits = document.getElementById('totalCredits');
        const creditsUsage = document.getElementById('creditsUsage');
        const creditsRemaining = document.getElementById('creditsRemaining');
        const creditsProgressBar = document.getElementById('creditsProgressBar');
        const creditsProgressLabel = document.getElementById('creditsProgressLabel');

        // --- App Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            populateSavedKeysDropdown();
        });

        // --- Event Listeners ---
        fetchButton.addEventListener('click', handleFetch);
        apiKeyInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                handleFetch();
            }
        });
        savedKeysSelect.addEventListener('change', handleKeySelection);
        deleteKeyButton.addEventListener('click', handleDeleteKey);

        /**
         * Main function to handle fetching and displaying the API data.
         */
        async function handleFetch() {
            const apiKey = apiKeyInput.value.trim();

            if (!apiKey) {
                showError("API Key cannot be empty.");
                return;
            }

            // --- UI state for loading ---
            setLoadingState(true);
            hideError();
            resultsContainer.classList.add('hidden');

            try {
                // The API endpoints
                const keyApiUrl = 'https://openrouter.ai/api/v1/key';
                const creditsApiUrl = 'https://openrouter.ai/api/v1/credits';

                const headers = {
                    'Authorization': `Bearer ${apiKey}`,
                };

                // Fetch data from both APIs concurrently
                const [keyResponse, creditsResponse] = await Promise.all([
                    fetch(keyApiUrl, { method: 'GET', headers }),
                    fetch(creditsApiUrl, { method: 'GET', headers })
                ]);

                // Check if the key response is ok
                if (!keyResponse.ok) {
                    const errorData = await keyResponse.json().catch(() => null);
                    const detail = errorData?.error?.message || `HTTP error! Status: ${keyResponse.status}`;
                    throw new Error(`Failed to fetch key details: ${detail}`);
                }

                // Check if the credits response is ok
                if (!creditsResponse.ok) {
                    const errorData = await creditsResponse.json().catch(() => null);
                    const detail = errorData?.error?.message || `HTTP error! Status: ${creditsResponse.status}`;
                    throw new Error(`Failed to fetch credit details: ${detail}`);
                }

                const keyResult = await keyResponse.json();
                const creditsResult = await creditsResponse.json();
                
                // --- Save key on successful fetch ---
                saveKey(apiKey, keyResult.data.label || `Key_${apiKey.slice(0, 6)}`);

                // --- Save usage history ---
                const remainingCredits = creditsResult.data.total_credits - creditsResult.data.total_usage;
                saveHistory(apiKey, remainingCredits);

                // --- Update the UI with the fetched data ---
                updateUI(keyResult.data, creditsResult.data);
                
                // --- Render history chart ---
                renderHistoryChart(apiKey);

            } catch (error) {
                console.error('Fetch error:', error);
                showError(`${error.message}`);
            } finally {
                // --- Reset UI loading state ---
                setLoadingState(false);
            }
        }
        
        /**
         * Updates the UI elements with data from the API.
         * @param {object} keyData - The data object from the /key API response.
         * @param {object} creditsData - The data object from the /credits API response.
         */
        function updateUI(keyData, creditsData) {
            if (!keyData || !creditsData) {
                showError("Received invalid data from the server.");
                return;
            }

            // --- Populate text fields (Key Data) ---
            keyLabel.textContent = keyData.label || 'No Label';
            usage.textContent = `$${keyData.usage.toFixed(4)}`;
            limit.textContent = `$${keyData.limit.toFixed(2)}`;
            limitRemaining.textContent = `$${keyData.limit_remaining.toFixed(4)}`;
            rateLimit.textContent = `${keyData.rate_limit.requests} / ${keyData.rate_limit.interval}`;
            freeTierStatus.textContent = keyData.is_free_tier ? 'Active' : 'Inactive';

            // --- Calculate and update progress bar (Key Data) ---
            const usagePercentage = (keyData.usage / keyData.limit) * 100;
            setTimeout(() => {
                 progressBar.style.width = `${Math.min(usagePercentage, 100)}%`;
            }, 100);
            progressLabel.textContent = `${usagePercentage.toFixed(2)}% Used`;

            // --- Populate text fields (Credits Data) ---
            // 1 credit = $1
            totalCredits.textContent = `$${(creditsData.total_credits).toFixed(2)}`;
            creditsUsage.textContent = `$${(creditsData.total_usage).toFixed(4)}`;
            const remainingCreditsValue = creditsData.total_credits - creditsData.total_usage;
            creditsRemaining.textContent = `$${(remainingCreditsValue).toFixed(4)}`;

            // --- Calculate and update progress bar (Credits Data) ---
            const creditsUsagePercentage = creditsData.total_credits > 0 ? (creditsData.total_usage / creditsData.total_credits) * 100 : 0;
            setTimeout(() => {
                 creditsProgressBar.style.width = `${Math.min(creditsUsagePercentage, 100)}%`;
            }, 100);
            creditsProgressLabel.textContent = `${creditsUsagePercentage.toFixed(2)}% Used`;
            
            // --- Make the results visible ---
            resultsContainer.classList.remove('hidden');
        }

        let usageChart = null; // Variable to hold the chart instance

        /**
         * Renders the usage history chart for a given API key.
         * @param {string} apiKey - The API key to render the chart for.
         */
        function renderHistoryChart(apiKey) {
            const history = (JSON.parse(localStorage.getItem(STORAGE_HISTORY)) || {})[apiKey] || [];

            const chartData = {
                labels: history.map(h => new Date(h.timestamp)),
                datasets: [{
                    label: 'Remaining Credits ($)',
                    data: history.map(h => h.remaining),
                    borderColor: '#38bdf8', // cyan-400
                    backgroundColor: 'rgba(56, 189, 248, 0.1)',
                    borderWidth: 2,
                    pointBackgroundColor: '#0ea5e9', // cyan-500
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    tension: 0.1,
                    fill: true
                }]
            };

            const config = {
                type: 'line',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                tooltipFormat: 'PPpp'
                            },
                            ticks: {
                                color: '#9ca3af', /* gray-400 */
                                callback: function(value) {
                                    const date = new Date(value);
                                    const options = {
                                        month: 'short',
                                        day: 'numeric',
                                        hour: '2-digit',
                                        minute: '2-digit',
                                        hour12: false
                                    };
                                    return date.toLocaleString([], options); // Use user's locale
                                }
                            },
                            grid: { color: 'rgba(156, 163, 175, 0.1)' }
                        },
                        y: {
                            beginAtZero: false,
                            ticks: {
                                color: '#9ca3af', /* gray-400 */
                                callback: function(value) {
                                    return '$' + value.toFixed(2);
                                }
                            },
                            grid: { color: 'rgba(156, 163, 175, 0.2)' }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: '#1f2937', // gray-800
                            titleColor: '#f3f4f6', // gray-100
                            bodyColor: '#d1d5db', // gray-300
                            borderColor: '#374151', // gray-700
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    return `Remaining: $${Number(context.raw).toFixed(4)}`;
                                }
                            }
                        }
                    }
                }
            };

            const ctx = document.getElementById('usageHistoryChart').getContext('2d');
            
            if (usageChart) {
                usageChart.destroy(); // Destroy the old chart instance before creating a new one
            }
            usageChart = new Chart(ctx, config);
        }

        /**
         * Handles selection of a key from the dropdown.
         */
        function handleKeySelection() {
            const selectedKey = savedKeysSelect.value;
            if (selectedKey) {
                apiKeyInput.value = selectedKey;
                handleFetch(); // Automatically fetch data for the selected key
            } else {
                // Clear results if "Select a saved key" is chosen
                resultsContainer.classList.add('hidden');
                if (usageChart) {
                    usageChart.destroy();
                    usageChart = null;
                }
            }
        }

        /**
         * Handles deleting the currently selected key.
         */
        function handleDeleteKey() {
            const selectedKey = savedKeysSelect.value;
            if (selectedKey) {
                if (confirm(`Are you sure you want to delete the key "${savedKeysSelect.options[savedKeysSelect.selectedIndex].text}"?`)) {
                    deleteKey(selectedKey);
                    apiKeyInput.value = '';
                    resultsContainer.classList.add('hidden');
                    hideError();
                    if (usageChart) {
                        usageChart.destroy();
                        usageChart = null;
                    }
                }
            } else {
                alert("Please select a key to delete.");
            }
        }

        /**
         * Populates the saved keys dropdown from localStorage.
         */
        function populateSavedKeysDropdown() {
            const keys = getSavedKeys();
            savedKeysSelect.innerHTML = '<option value="">Select a saved key</option>'; // Reset
            keys.forEach(keyObj => {
                const option = document.createElement('option');
                option.value = keyObj.key;
                option.textContent = keyObj.label;
                savedKeysSelect.appendChild(option);
            });
        }

        /**
         * Retrieves saved keys from localStorage.
         * @returns {Array<object>} An array of key objects.
         */
        function getSavedKeys() {
            return JSON.parse(localStorage.getItem(STORAGE_KEYS)) || [];
        }

        /**
         * Saves a key to localStorage if it doesn't already exist.
         * @param {string} apiKey - The API key.
         * @param {string} label - The label for the key.
         */
        function saveKey(apiKey, label) {
            const keys = getSavedKeys();
            const existingKey = keys.find(k => k.key === apiKey);
            if (!existingKey) {
                keys.push({ key: apiKey, label: label });
                localStorage.setItem(STORAGE_KEYS, JSON.stringify(keys));
                populateSavedKeysDropdown();
            } else if (existingKey.label !== label) {
                // Update label if it has changed
                existingKey.label = label;
                localStorage.setItem(STORAGE_KEYS, JSON.stringify(keys));
                populateSavedKeysDropdown();
            }
        }

        /**
         * Deletes a key and its history from localStorage.
         * @param {string} apiKey - The API key to delete.
         */
        function deleteKey(apiKey) {
            let keys = getSavedKeys();
            keys = keys.filter(k => k.key !== apiKey);
            localStorage.setItem(STORAGE_KEYS, JSON.stringify(keys));
            
            let history = JSON.parse(localStorage.getItem(STORAGE_HISTORY)) || {};
            delete history[apiKey];
            localStorage.setItem(STORAGE_HISTORY, JSON.stringify(history));

            populateSavedKeysDropdown();
        }

        /**
         * Saves a history entry for a given API key.
         * @param {string} apiKey - The API key.
         * @param {number} remainingBalance - The remaining credits.
         */
        function saveHistory(apiKey, remainingBalance) {
            let history = JSON.parse(localStorage.getItem(STORAGE_HISTORY)) || {};
            if (!history[apiKey]) {
                history[apiKey] = [];
            }
            history[apiKey].push({
                timestamp: new Date().toISOString(),
                remaining: remainingBalance
            });
            // Optional: Limit history size to e.g. last 100 entries per key
            if (history[apiKey].length > 100) {
                history[apiKey].shift();
            }
            localStorage.setItem(STORAGE_HISTORY, JSON.stringify(history));
        }

        /**
         * Manages the loading state of the fetch button.
         * @param {boolean} isLoading - Whether the app is in a loading state.
         */
        function setLoadingState(isLoading) {
            if (isLoading) {
                fetchButton.disabled = true;
                buttonText.textContent = 'Fetching...';
                spinner.classList.remove('hidden');
            } else {
                fetchButton.disabled = false;
                buttonText.textContent = 'Fetch Stats';
                spinner.classList.add('hidden');
            }
        }

        /**
         * Displays an error message in the UI.
         * @param {string} message - The error message to display.
         */
        function showError(message) {
            errorMessage.textContent = message;
            errorContainer.classList.remove('hidden');
        }

        /**
         * Hides the error message container.
         */
        function hideError() {
            errorContainer.classList.add('hidden');
        }

    </script>
</body>
</html>

